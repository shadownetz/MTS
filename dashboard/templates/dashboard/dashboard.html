{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8" />
    <title>MTS | POS Dashboard</title>
    <meta name="description" content="Updates and statistics" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <!--begin::Fonts-->
    <!-- <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700" /> -->
    <!--end::Fonts-->
    <link rel="stylesheet" href="{% static 'home/vendors/fontawesome/css/all.min.css' %}">
    <!--begin::Global Theme Styles(used by all pages)-->
    <link href="{% static 'dashboard/assets/css/style.css@v=1.0.css' %}" rel="stylesheet" type="text/css" />
    <!--end::Global Theme Styles-->

    <link href="{% static 'dashboard/assets/css/animate.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'dashboard/assets/api/pace/pace-theme-flat-top.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'dashboard/assets/api/mcustomscrollbar/jquery.mCustomScrollbar.css' %}" rel="stylesheet" type="text/css" />

    <link href="{% static 'dashboard/assets/css/jquery.dataTables.min.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'dashboard/assets/css/multiple-select.min.css' %}" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{% static 'dashboard/assets/css/daterangepicker.css' %}" />

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'home/favicon/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'home/favicon/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'home/favicon/favicon-16x16.png' %}">
    <link rel="manifest" href="{% static 'home/favicon/site.webmanifest' %}">
    <link rel="mask-icon" href="{% static 'home/favicon/safari-pinned-tab.svg' %}" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#dccbee">

    {% block link %}{% endblock %}
    <style>
        .bg-pos{
            background: rgb(250,250,250) url("{% static 'home/images/logo/mts_logo.png' %}") no-repeat center center!important;
            background-size: contain!important;
        }
    </style>
    {% block style %}{% endblock %}
</head>
<!--end::Head-->
<!--begin::Body-->

<body id="tc_body" class="header-fixed header-mobile-fixed subheader-enabled aside-enabled aside-fixed">
<!-- Paste this code after body tag -->
<div class="se-pre-con">
    <div class="pre-loader">
        <img class="img-fluid" src="{% static 'dashboard/assets/images/loadergif.gif' %}" alt="loading">
    </div>
</div>
<!-- pos header -->

<header class="pos-header bg-white">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-xl-4 col-lg-4 col-md-6">
                <div class="greeting-text">
                    <h3 class="card-label mb-0 font-weight-bold text-primary">WELCOME
                    </h3>
                    <h3 class="card-label mb-0 text-truncate">
                        {{ request.user.name|truncatewords:4 }}
                    </h3>
                </div>

            </div>
            <div class="col-xl-4 col-lg-5 col-md-6  clock-main">
                <div class="clock">
                    <div class="datetime-content">
                        <ul>
                            <li id="hours"></li>
                            <li id="point1">:</li>
                            <li id="min"></li>
                            <li id="point">:</li>
                            <li id="sec"></li>
                        </ul>
                    </div>
                    <div class="datetime-content">
                        <div id="Date"  class=""></div>
                    </div>

                </div>

            </div>
            <div class="col-xl-4 col-lg-3 col-md-12  order-lg-last order-second">
                <div class="topbar justify-content-end">
                    <div class="dropdown mega-dropdown">
                        <div id="id2" class="topbar-item "  data-toggle="dropdown" data-display="static">
                            <div class="btn btn-icon w-auto h-auto btn-clean d-flex align-items-center py-0 mr-3">

							 <span class="symbol symbol-35 symbol-light-success">
								 <span class="symbol-label bg-primary  font-size-h5 ">

									 <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="#fff" class="bi bi-calculator-fill" viewBox="0 0 16 16">
										 <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm2 .5v2a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 0-.5-.5h-7a.5.5 0 0 0-.5.5zm0 4v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zM4.5 9a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zM4 12.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zM7.5 6a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zM7 9.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zm.5 2.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zM10 6.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zm.5 2.5a.5.5 0 0 0-.5.5v4a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 0-.5-.5h-1z"/>
									   </svg>
								 </span>
							 </span>
                            </div>
                        </div>
                        <div class="dropdown-menu dropdown-menu-right calu" style="min-width: 248px;">
                            <div class="calculator">
                                <div class="input" id="input"></div>
                                <div class="buttons">
                                    <div class="operators">
                                        <div>+</div>
                                        <div>-</div>
                                        <div>&times;</div>
                                        <div>&divide;</div>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <div class="leftPanel">
                                            <div class="numbers">
                                                <div>7</div>
                                                <div>8</div>
                                                <div>9</div>
                                            </div>
                                            <div class="numbers">
                                                <div>4</div>
                                                <div>5</div>
                                                <div>6</div>
                                            </div>
                                            <div class="numbers">
                                                <div>1</div>
                                                <div>2</div>
                                                <div>3</div>
                                            </div>
                                            <div class="numbers">
                                                <div>0</div>
                                                <div>.</div>
                                                <div id="clear">C</div>
                                            </div>
                                        </div>
                                        <div class="equal" id="result">=</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <div class="topbar-item" data-toggle="dropdown" data-display="static">
                            <div class="btn btn-icon w-auto h-auto btn-clean d-flex align-items-center py-0">

							 <span class="symbol symbol-35 symbol-light-success">
								 <span class="symbol-label font-size-h5 ">
									 <svg width="20px" height="20px" viewBox="0 0 16 16" class="bi bi-person-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
										 <path fill-rule="evenodd" d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path>
									 </svg>
								 </span>
							 </span>
                            </div>
                        </div>
                        <div class="dropdown-menu dropdown-menu-right" style="min-width: 150px;">
                            <a href="{% url 'dashboard:logout' %}" class="dropdown-item">
							 <span class="svg-icon svg-icon-xl svg-icon-primary mr-2">
								 <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-power">
									 <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
									 <line x1="12" y1="2" x2="12" y2="12"></line>
								 </svg>
							 </span>
                                Logout
                            </a>
                            <a href="{% url 'dashboard:statistics' %}" class="dropdown-item">
                                <i class="fa fa-briefcase pr-4"></i> MTS Management
                            </a>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>
</header>


<div id="pos" class="contentPOS">
    <div class="container-fluid">
        <form role="form" @submit.prevent="saveSale">
            <div class="row">
                <div class="col-xl-4 order-xl-first order-last">
                    <div class="card card-custom gutter-b bg-white border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between colorfull-select">
                                <div class="selectmain">
                                    <select class="w-150px bag-primary" v-model="filter_by">
                                        <option value="">All Categories</option>
                                        {% for category in categories %}
                                            <option value="{{ category.id }}">
                                                {{ category.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                {#                            <div class="selectmain">#}
                                {#                                <select class="arabic-select w-150px bag-secondary">#}
                                {#                                    <option value="1">Men's</option>#}
                                {#                                    <option value="2">Accessories</option>#}
                                {#                                </select>#}
                                {#                            </div>#}
                            </div>
                        </div>
                        <div class="product-items">
                            <div class="row">
                                <template v-if="all_products.length > 0">
                                    <div class="col-xl-4 col-lg-2 col-md-3 col-sm-4 col-6" v-for="(product, idx) in all_products" :key="'prod_list_'+idx">
                                        <div class="productCard">
                                            <div class="productThumb">
                                                <img class="img-fluid" :src="product.image" alt="product image">
                                            </div>
                                            <div class="productContent">
                                                <a href="javascript:void(0)" v-if="product.quantity > 0" @click="addItem(product)">
                                                    <i class="fa fa-bell"></i>
                                                    [[product.name.substr(0,15)]] (x[[product.quantity]]) [[product.code]]
                                                </a>
                                                <span class="text-muted" title="out of stock" v-else>
                                                <i class="fa fa-ban"></i>  [[product.name]] -[[product.code]]
                                        </span>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                <template v-else>
                                    <div class="col-12 text-center mt-5">
                                        <h5>No Items have been added yet</h5>
                                        <p>Click <a class="text-primary" href="{% url 'dashboard:products' %}">here</a> to add a new product</p>
                                    </div>
                                </template>
                            </div>
                        </div>


                    </div>
                </div>
                <div class="col-xl-5 col-lg-8 col-md-8">
                    <div class="">
                        <div class="card card-custom gutter-b bg-white border-0 table-contentpos">
                            <div class="card-body" >
                                <div class="form-group row mb-0">
                                    <div class="col-md-12">
                                        <label >Selected Items</label>
                                        {#                                    <fieldset class="form-group mb-0 d-flex barcodeselection">#}
                                        {#                                        <select class="form-control w-25" id="exampleFormControlSelect1">#}
                                        {#                                            <option>Name</option>#}
                                        {#                                            <option>SKU</option>#}
                                        {#                                        </select>#}
                                        {#                                        <input type="text" class="form-control border-dark" id="basicInput1" placeholder="">#}
                                        {#                                    </fieldset>#}
                                    </div>
                                </div>
                            </div>
                            <div class="table-datapos pb-3">
                                <div class="table-responsive" v-if="items.length > 0">
                                    <table id="orderTable" class="display" style="width:100%">
                                        <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Amount</th>
                                            <th>Quantity</th>
                                            <th>Discount (%)</th>
                                            <th>Subtotal</th>
                                            <th class=" text-right no-sort"></th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr v-for="(item, idx) in items" :key="'item_'+idx">
                                            <td v-if="all_products.filter(product=>product.id===Number.parseInt(item.product_id)).length > 0" class="">
                                                [[ all_products.filter(product=>product.id===Number.parseInt(item.product_id))[0].name ]]
                                            </td>
                                            <td v-else>[[item.product_id]]</td>
                                            <td>
                                                <input v-model.number="item.amount" type="number" class="form-control border-dark w-100px">
                                            </td>
                                            <td>
                                                <input v-model.number="item.quantity" min="1" :max="productClass.get_quantity(all_products, item.product_id)" type="number" class="form-control border-dark w-100px">
                                            </td>
                                            <td>
                                                <input v-model.number="item.discount" type="number" class="form-control border-dark w-100px">
                                            </td>
                                            <td>[[item.get_total]]</td>
                                            <td>
                                                <div class="card-toolbar text-right">
                                                    <a href="javascript:void(0)" title="Delete" @click="items.splice(idx,1)">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-12 text-center" v-else>
                                    <h5>No Item selected.</h5>
                                    <p>click on a product to make a new sale</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-4 col-md-4">
                    <div class="card card-custom gutter-b bg-white border-0">
                        <div class="card-body" >
                            <div class="shop-profile">
                                <div class="media">
                                    <div class="bg-pos bg-primary w-100px h-100px d-flex justify-content-center align-items-center">
                                        {#                                        <h2 class="mb-0 white">K</h2>#}
                                    </div>
                                    <div class="media-body ml-3">
                                        <h3 class="title font-weight-bold">The MTS POS</h3>
                                        <p class="phoonenumber">
                                            {{ request.user.phone }}
                                        </p>
                                        <p class="adddress">
                                            {{ request.user.address|truncatewords:9 }}
                                        </p>
                                        <p class="countryname">
                                            {% if request.user.is_staff %} Admin {% else %} Staff {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="resulttable-pos">
                                <table class="table right-table">

                                    <tbody>
                                    <tr class="d-flex align-items-center justify-content-between">
                                        <th class="border-0 font-size-h5 mb-0 font-size-bold text-dark">
                                            Total Items
                                        </th>
                                        <td class="border-0 justify-content-end d-flex text-dark font-size-base">
                                            [[items.length]]
                                        </td>

                                    </tr>
                                    <tr class="d-flex align-items-center justify-content-between">
                                        <th class="border-0 font-size-h5 mb-0 font-size-bold text-dark">
                                            Net Quantity
                                        </th>
                                        <td class="border-0 justify-content-end d-flex text-dark font-size-base">
                                            [[net_quantity]]
                                        </td>

                                    </tr>
                                    <tr class="d-flex align-items-center justify-content-between">
                                        <th class="border-0 ">
                                            <div class="d-flex align-items-center font-size-h5 mb-0 font-size-bold text-dark">
                                                NET DISCOUNT
                                            </div>
                                        </th>
                                        <td class="border-0 justify-content-end d-flex text-dark font-size-base">
                                            [[net_discount]]%
                                        </td>

                                    </tr>
                                    <tr class="d-flex align-items-center justify-content-between item-price">
                                        <th class="border-0 font-size-h5 mb-0 font-size-bold text-primary">
                                            TOTAL
                                        </th>
                                        <td class="border-0 justify-content-end d-flex text-primary font-size-base">
                                            â‚¦[[net_total]]
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div v-if="items.length > 0" class="d-flex justify-content-end align-items-center flex-column buttons-cash">
                                <div>
                                    <button type="submit" @click="paid_in_cash=true" class="btn btn-primary white mb-2"  data-toggle="modal" data-target="#payment-popup">
                                        <i class="fas fa-money-bill-wave mr-2"></i>
                                        Paid with Cash
                                    </button>
                                </div>
                                <div>
                                    <button type="submit" @click="paid_in_cash=false" class="btn btn-outline-secondary ">
                                        <i class="fas fa-credit-card mr-2"></i>
                                        Paid with Card
                                    </button>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<input id="api_products_fetch_url" type="hidden" value="{% url 'dashboard:api_products_fetch' %}">
<input id="api_admins_fetch_url" type="hidden" value="{% url 'dashboard:api_admins_get' %}">


<script src="{% static 'dashboard/assets/js/plugin.bundle.min.js' %}"></script>
<script src="{% static 'dashboard/assets/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'dashboard/assets/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'dashboard/assets/js/multiple-select.min.js' %}"></script>
<script src="{% static 'dashboard/assets/js/sweetalert.js' %}"></script>
<script src="{% static 'dashboard/assets/js/sweetalert1.js' %}"></script>
<script src="{% static 'dashboard/assets/js/script.bundle.js' %}"></script>
<script>window.$ = jQuery;</script>
<script src="{% static 'dashboard/assets/custom-js/csrf_ajax.js' %}"></script>
<script src="{% static 'dashboard/assets/custom-js/modules.js' %}"></script>
<script src="{% static 'dashboard/assets/plugins/vue/vue.js' %}"></script>
<script>
    jQuery(function() {
        jQuery('.arabic-select').multipleSelect({
            filter: true,
            filterAcceptOnEnter: true
        })
    });
    jQuery(function() {
        jQuery('.js-example-basic-single').multipleSelect({
            filter: true,
            filterAcceptOnEnter: true
        })
    });
    jQuery(document).ready(function() {
        jQuery('#orderTable').DataTable({

            "info":     false,
            "paging":   false,
            "searching": false,

            "columnDefs": [ {
                "targets"  : 'no-sort',
                "orderable": false,
            }]
        });
    } );
</script>
<script>
    new Vue({
        el: '#pos',
        delimiters: ['[[', ']]'],
        data(){
            return {
                products: [],
                filter_by: '',
                items: [],
                productClass: Product,
                paid_in_cash: true
            }
        },
        computed: {
            all_products(){
                return this.products.filter(product=>{
                    if(this.filter_by)
                        return product.category_id === Number.parseInt(this.filter_by);
                    return true
                })
            },
            net_quantity(){
                if(this.items.length > 0)
                    return this.items.map(item=>item.quantity).reduce((prev, curr)=>prev+curr);
                return 0
            },
            net_total(){
                if(this.items.length > 0)
                    return this.items.map(item=>item.get_total).reduce((prev, curr)=>prev+curr);
                return 0
            },
            net_discount(){
                if(this.items.length > 0)
                    return this.items.map(item=>item.discount).reduce((prev, curr)=>prev+curr);
                return 0
            }
        },
        methods: {
            async fetchProducts(){
                this.products = (await new Product().fetch_products()).products;
            },
            addItem(product){
                if(this.items.filter(item=>item.product_id===product.id).length > 0){
                    return dispAlert('This product has already been added');
                }
                this.items.push(new Sale(product.id))
            },
            async saveSale(){
                try{
                    const {paid_in_cash} = this;
                    let response = await $.ajax({
                        url: "{% url 'dashboard:api_sale_add' %}",
                        type: 'POST',
                        data: {
                            user_id: {{ request.user.id }},
                            paid_in_cash,
                            sales: JSON.stringify(this.items)
                        },
                        dataType: 'json',
                    });
                    if(response.status){
                        this.items = [];
                        dispAlert("Operation Successful", 'success');
                        await this.fetchProducts();
                        // Send sms notification for products
                        // that are out of stock
                        const products_names = this.products
                            .filter(product=>product.quantity <= 0)
                            .map(product=>product.name);
                        if(products_names.length > 0){
                            const message = `The products ${products_names.join(',')} are out of stock`;
                            response = await User.getAdmins();
                            if(response.status){
                                const recipients = response.admins.map(admin=>admin.phone).join(',');
                                const sms_payload = {message, recipients};
                                response = await (new SMS().sendAlert(sms_payload));
                                if(response.status){
                                    console.log("All operations completed successfully!")
                                }
                            }else{
                                console.error("An unknown error occurred while fetching admins")
                            }
                        }
                    }else{
                        throw new Error("An unknown error occurred while adding sales");
                    }
                }catch (e) {
                    dispAlert(e.message||e.messageText, 'error');
                    console.log(e)
                }
            }
        },
        created(){
            this.fetchProducts()
        }
    })
</script>
</body>
<!--end::Body-->


</html>